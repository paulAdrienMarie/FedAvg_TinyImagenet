# Simulation of Federated Learning using ONNXRuntime

This project simulates a federated learning scenario on one single computer. The model used in this project is the google vit patch16 224 with a classification head.

In a Federated Learning scenario, a global model is served by a server to end users. Users train the model on their local data and therefore modifies the weights of the model. Local weights are then sent back to the server that averages them. These new weights are then injected in the next version of the model and so on until a target accuracy is reached.

The Federated Learning simulation is here implemented using a web application. The frontend is in JavaScript and the backend is in Python using aiohttp. The model is trained directly on the browser as it would happen in a real scenario of Federated Learning.

## Local training

Training directly on the browser is done by using the ONNXRuntime Javascript API that recently proposed a TrainingSession object. The preprocessing is done using the Tensorflow Javascript API.

Before runnimng the web application and make the training happen you need to generate the training artifacts. Learn more by looking at the README file in the artifacts folder.

## Implementation logic 

The provided version runs for `100 users`. Each user has `600 images` to treat. This can be modified within the command line to execute the code. 

For each user, a json file is generated by the `FederatedPreparer.py` script. Each file contains the labels and the images in base64 string format assigned to the user. These files are fetched by the user during the simulation.

To speed up the simulation, users are executed in separated workers by batches of 5. Once a user have completed its training loop, the parameters are sent back to the python server that stores them. 

When the Python server have received all the individual updated parameters, it averages them and injects them into the next version of the model and saves it in the onnx format. The training artifacts are re generated based on this new version of the model and this loop can happen again.  

Run this loop as many time as needed to reach your target accuracy. 

## Install Requirements  

- Create a new virtual environnement : `python3 -m venv env` and activate it `source env/bin/activate`. Install the requirements for this project `pip install -r requirements.txt`.

## Run the project

To run the whole project you will need two terminals. One will launch the web application and the other will connect to it and launch the simulation.

- Terminal 1 : `python watcher.py`
- Terminal 2 : `python Federated.py --nb_users=100 --batch_size=600 --nb_roc=50`

## Details of the files

### Prepare Dataset for Federated Learning scenario

- `Artifacts.py` : Script to create the onnx model, save it and generate the training artifacts. See `README.md` in the artifacts folder.
- `PrepareFederated.py` : Script to generate clients datasets and training artifact
- `Federated.py` : Script to launch the federated learning simulation in headless mode using selemium
- `ModelUpdater.py` : Script to generate the string representation of the images using base64 encoding
- `Evaluate.py` : Script to evaluate the updated model using the training artifacts and the model

### Web Server

- `main.py` : Script to launch the python server
- `routes.py` : Script to specify the routes of the python server
- `view.py` : Script to define which function to run to handle a request on a route
- `watcher.py` : Script to restart the server when a file is modified within the project

### Other

- `FineTuner.py` : Script to fine tune the google vit model on TinyImagenet


